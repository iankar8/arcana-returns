---
title: 'Idempotency'
description: 'Prevent duplicate operations with idempotency keys'
---

## Overview

Idempotency ensures that the same API request can be safely retried without creating duplicate operations. This is critical for financial transactions like returns and refunds.

<Tip>
  Always use idempotency keys in production to prevent duplicate charges, double refunds, or duplicate returns.
</Tip>

## How It Works

When you include an `Idempotency-Key` header, Arcana:
1. **First request:** Processes normally and caches the response for 24 hours
2. **Duplicate requests:** Returns the cached response (same status code, same body)
3. **Concurrent requests:** Returns 429 to prevent race conditions

## Usage

<CodeGroup>

```javascript Node.js
const response = await fetch('https://arcana-returns-api.fly.dev/returns/token', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer sk_live_...',
    'Content-Type': 'application/json',
    'Idempotency-Key': `order-${orderId}-return-${timestamp}`
  },
  body: JSON.stringify({ /* ... */ })
});
```

```bash cURL
curl -X POST https://arcana-returns-api.fly.dev/returns/token \
  -H "Authorization: Bearer sk_live_..." \
  -H "Idempotency-Key: order-123-return-001" \
  -H "Content-Type: application/json" \
  -d '{ ... }'
```

</CodeGroup>

## Key Format

### Recommended Patterns

<AccordionGroup>
  <Accordion title="Order-based">
    ```
    order-{order_id}-return-{attempt_number}
    ```
    Example: `order-12345-return-1`
    
    **Use when:** Processing returns for orders
  </Accordion>
  
  <Accordion title="Timestamp-based">
    ```
    {resource}-{id}-{timestamp}
    ```
    Example: `refund-789-1729972800000`
    
    **Use when:** Operations can be retried multiple times
  </Accordion>
  
  <Accordion title="UUID-based">
    ```
    {operation}-{uuid}
    ```
    Example: `return-550e8400-e29b-41d4-a716-446655440000`
    
    **Use when:** Guaranteed uniqueness required
  </Accordion>
</AccordionGroup>

<Warning>
  **Don't use:** Sequential numbers alone (e.g., `1`, `2`, `3`) - these collide across merchants!
</Warning>

## Behavior

### Successful Request

**First call:**
```bash
POST /returns/token
Idempotency-Key: order-123-return-1

→ 200 OK
{
  "return_token": "rt.eyJ...",
  "risk_score": 0.2
}
```

**Retry (same key):**
```bash
POST /returns/token  
Idempotency-Key: order-123-return-1

→ 200 OK (same response from cache)
{
  "return_token": "rt.eyJ...",
  "risk_score": 0.2
}
```

### Concurrent Requests

**Request 1 in progress:**
```bash
POST /returns/token
Idempotency-Key: order-123-return-1

→ Processing...
```

**Request 2 (same key, concurrent):**
```bash
POST /returns/token
Idempotency-Key: order-123-return-1

→ 429 Too Many Requests
{
  "error": {
    "code": "IDEMP-001",
    "message": "Request with this idempotency key is already in progress",
    "suggestion": "Wait for the first request to complete before retrying"
  }
}
```

### Different Request Body

<Warning>
  If you use the same idempotency key with **different request body**, you'll get a **409 Conflict** error.
</Warning>

```bash
# First request
POST /returns/token
Idempotency-Key: order-123-return-1
Body: {"order_id": "ord_123", "items": [...]}

→ 200 OK

# Second request (same key, different body)
POST /returns/token
Idempotency-Key: order-123-return-1
Body: {"order_id": "ord_456", "items": [...]}

→ 409 Conflict
{
  "error": {
    "code": "IDEMP-002",
    "message": "Request body doesn't match original request for this idempotency key"
  }
}
```

## Expiration

Idempotency keys are cached for **24 hours**. After that:
- The key expires and can be reused
- A new request with the same key will be processed as a new operation

## Best Practices

<AccordionGroup>
  <Accordion title="Always Use in Production">
    Idempotency keys should be used for **all** POST requests in production. Network issues, timeouts, and retries are common - protect yourself!
  </Accordion>
  
  <Accordion title="Generate Keys Client-Side">
    Generate idempotency keys on the client before making the request. This ensures the same key is used for retries.
    
    ```javascript
    // Good: Generate once
    const key = `order-${orderId}-return-${Date.now()}`;
    const response = await makeRequest(key);
    
    // Bad: Generate on retry
    await makeRequest(`key-${Math.random()}`); // Different every time!
    ```
  </Accordion>
  
  <Accordion title="Include Context in Keys">
    Make keys descriptive so you can debug issues:
    
    ```
    Good: order-12345-return-attempt-2
    Bad: abc123xyz
    ```
  </Accordion>
  
  <Accordion title="Handle 409 Conflicts">
    If you get a 409, it means you're trying to reuse a key for a different operation. Generate a new key.
    
    ```javascript
    try {
      await makeRequest(key, body);
    } catch (error) {
      if (error.code === 'IDEMP-002') {
        // Different request body - need new key
        const newKey = `${key}-v2`;
        await makeRequest(newKey, body);
      }
    }
    ```
  </Accordion>
  
  <Accordion title="Clean Up Keys Periodically">
    Keys are automatically cleaned up after 24 hours. No manual cleanup needed!
  </Accordion>
</AccordionGroup>

## Error Codes

| Code | Status | Description |
|------|--------|-------------|
| `IDEMP-001` | 429 | Request in progress with same key |
| `IDEMP-002` | 409 | Request body mismatch |

## FAQ

<AccordionGroup>
  <Accordion title="Do I need idempotency for GET requests?">
    No. GET requests are safe to retry by definition. Only use idempotency keys for POST requests that modify state.
  </Accordion>
  
  <Accordion title="What if I don't include an idempotency key?">
    The request will still work, but won't be protected against duplicates. Not recommended for production!
  </Accordion>
  
  <Accordion title="Can I reuse keys across different endpoints?">
    Technically yes (keys are scoped per endpoint), but not recommended. Use unique keys to avoid confusion.
  </Accordion>
  
  <Accordion title="What happens after 24 hours?">
    The cached response expires and the key can be reused. If you make the same request again, it will be processed as a new operation.
  </Accordion>
</AccordionGroup>

## Next Steps

<CardGroup>
  <Card title="Error Handling" icon="circle-exclamation" href="/reference/error-codes">
    Learn about all error codes
  </Card>
  <Card title="Rate Limiting" icon="gauge" href="/guides/rate-limiting">
    Understand rate limits
  </Card>
</CardGroup>
